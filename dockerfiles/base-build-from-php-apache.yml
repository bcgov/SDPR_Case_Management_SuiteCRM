# syntax=docker/dockerfile:1
FROM php:8.2-apache AS cbsuitecrm

ADD --chmod=0755 https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/

ADD --chmod=0755 https://github.com/bcgov/SDPR_Case_Management_SuiteCRM/tree/main/suitecrm /suitecrm

# The following lines are split to allow easy editing or commenting out of each statement 

# Update and upgrade packages
RUN apt update
RUN apt upgrade -y
RUN apt install sudo -y
RUN apt install nano -y 
RUN apt install systemctl -y 
# RUN service cron start
RUN sudo rm -rf /etc/localtime
RUN sudo ln -s /usr/share/zoneinfo/America/Vancouver /etc/localtime
RUN install-php-extensions intl gd mbstring mysqli pdo_mysql soap zip

# Enable mod rewrite for Apache

RUN sudo a2enmod rewrite

# Enable ssl for Apache

RUN sudo a2enmod ssl

# Add the user www-data to the root group

RUN sudo adduser www-data root 


# Change to the SuiteCRM direcotry and clear the cache
RUN ls -l /

RUN cd /suitecrm
RUN ./bin/console cache:clear

# Set permissions for the root group and www-data on the suitecrm folder

RUN find . -type d -not -perm 2755 -exec chmod 2755 {} \;
RUN find . -type f -not -perm 0644 -exec chmod 0644 {} \;
RUN find . ! -user www-data -exec chown www-data:root {} \;
RUN chmod +x bin/console

# Change group to root and then mod folder for the root group 

RUN chgrp -R root /suitecrm
RUN chmod -R g+rwx /suitecrm




