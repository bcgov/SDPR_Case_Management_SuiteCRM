/**
 * SuiteCRM is a customer relationship management program developed by SalesAgility Ltd.
 * Copyright (C) 2021 SalesAgility Ltd.
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU Affero General Public License version 3 as published by the
 * Free Software Foundation with the addition of the following permission added
 * to Section 15 as permitted in Section 7(a): FOR ANY PART OF THE COVERED WORK
 * IN WHICH THE COPYRIGHT IS OWNED BY SALESAGILITY, SALESAGILITY DISCLAIMS THE
 * WARRANTY OF NON INFRINGEMENT OF THIRD PARTY RIGHTS.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * In accordance with Section 7(b) of the GNU Affero General Public License
 * version 3, these Appropriate Legal Notices must retain the display of the
 * "Supercharged by SuiteCRM" logo. If the display of the logos is not reasonably
 * feasible for technical reasons, the Appropriate Legal Notices must display
 * the words "Supercharged by SuiteCRM".
 */
import { Inject, Injectable, LOCALE_ID } from '@angular/core';
import { UserPreferenceStore } from '../../../store/user-preference/user-preference.store';
import { map } from 'rxjs/operators';
import { formatDate } from '@angular/common';
import { DateTime, IANAZone } from 'luxon';
import { FormControlUtils } from '../../record/field/form-control.utils';
import * as i0 from "@angular/core";
import * as i1 from "../../../store/user-preference/user-preference.store";
import * as i2 from "../../record/field/form-control.utils";
class DatetimeFormatter {
    constructor(preferences, formUtils, locale) {
        this.preferences = preferences;
        this.formUtils = formUtils;
        this.locale = locale;
        this.format$ = this.preferences.userPreferences$.pipe(map(() => {
            const date = this.getDateFormat();
            const time = this.getTimeFormat();
            return { date, time };
        }));
    }
    getDateFormat() {
        const dateFormatPreference = this.preferences.getUserPreference('date_format');
        if (dateFormatPreference) {
            return dateFormatPreference;
        }
        return this.getInternalTimeFormat();
    }
    getTimeFormat() {
        const timeFormatPreference = this.preferences.getUserPreference('time_format');
        if (timeFormatPreference) {
            let format = timeFormatPreference;
            if (format.includes('aaaaaa')) {
                format = format.replace('aaaaaa', 'aaaaa\'m\'');
            }
            return format;
        }
        return this.getInternalTimeFormat();
    }
    getDateTimeFormat() {
        const dateFormat = this.getDateFormat();
        const timeFormat = this.getTimeFormat();
        return dateFormat + ' ' + timeFormat;
    }
    getInternalDateFormat() {
        return 'yyyy-MM-dd';
    }
    getInternalTimeFormat() {
        return 'HH:mm:ss';
    }
    getInternalDateTimeFormat() {
        const dateFormat = this.getInternalDateFormat();
        const timeFormat = this.getInternalTimeFormat();
        return dateFormat + ' ' + timeFormat;
    }
    getInternalFormat() {
        return this.getInternalDateTimeFormat();
    }
    getUserFormat() {
        return this.getDateTimeFormat();
    }
    /**
     * Format Internal Date to User. It assumes internal date is in GMT/UTC
     *
     * @param dateString
     * @param options
     */
    toUserFormat(dateString, options) {
        const fromFormat = (options && options.fromFormat) || this.getInternalFormat();
        if (dateString) {
            const dateTime = this.toDateTime(dateString, fromFormat, {
                zone: 'GMT'
            });
            if (!dateTime.isValid) {
                return dateString;
            }
            return formatDate(dateTime.toJSDate(), this.getUserFormat(), this.locale, this.userTimeZone());
        }
        return '';
    }
    /**
     * Format User Date to Internal format. It assumes the date is in the user timezone
     *
     * @param dateString
     * @param options
     */
    toInternalFormat(dateString, options) {
        const fromFormat = (options && options.fromFormat) || this.getUserFormat();
        if (dateString) {
            let date = this.toDateTime(dateString, fromFormat, {
                zone: this.preferences.getUserPreference('timezone')
            });
            return formatDate(date.toJSDate(), this.getInternalFormat(), this.locale, 'GMT');
        }
        return '';
    }
    formatDateTime(dateString, format, fromFormat = '', locale = this.locale, timezone = '') {
        const dateTime = this.toDateTime(dateString, fromFormat);
        if (!dateTime.isValid) {
            return dateString;
        }
        return formatDate(dateTime.toJSDate(), format, locale, timezone);
    }
    toDateTime(datetimeString, fromFormat = '', options) {
        if (!datetimeString) {
            return DateTime.invalid('empty');
        }
        if (fromFormat) {
            return DateTime.fromFormat(datetimeString, fromFormat, options);
        }
        let dateTime = this.fromUserFormat(datetimeString, options);
        if (!dateTime.isValid) {
            dateTime = this.fromInternalFormat(datetimeString, options);
        }
        return dateTime;
    }
    userDateTimeFormatToStruct(datetime) {
        if (!datetime) {
            return null;
        }
        const dateTime = this.toDateTime(datetime, '', {
            zone: this.preferences.getUserPreference('timezone')
        });
        if (!dateTime.isValid) {
            return null;
        }
        return {
            date: {
                day: dateTime.day,
                month: dateTime.month,
                year: dateTime.year
            },
            time: {
                hour: dateTime.hour,
                minute: dateTime.minute,
                second: dateTime.second,
            }
        };
    }
    internalDateTimeFormatToStruct(datetime) {
        if (!datetime) {
            return null;
        }
        const dateTime = this.toDateTime(datetime, this.getInternalDateTimeFormat(), {
            zone: 'GMT'
        });
        const rezoned = dateTime.setZone(this.preferences.getUserPreference('timezone'));
        if (!dateTime.isValid) {
            return null;
        }
        return {
            date: {
                day: rezoned.day,
                month: rezoned.month,
                year: rezoned.year
            },
            time: {
                hour: rezoned.hour,
                minute: rezoned.minute,
                second: rezoned.second,
            }
        };
    }
    userDateFormatToStruct(datetime) {
        if (!datetime) {
            return null;
        }
        const dateTime = this.toDateTime(datetime, '', {
            zone: this.preferences.getUserPreference('timezone')
        });
        if (!dateTime.isValid) {
            return null;
        }
        return {
            day: dateTime.day,
            month: dateTime.month,
            year: dateTime.year
        };
    }
    dateFormatToStruct(datetime, fromFormat = '') {
        if (!datetime) {
            return null;
        }
        const dateTime = this.toDateTime(datetime, fromFormat);
        if (!dateTime.isValid) {
            return null;
        }
        return {
            day: dateTime.day,
            month: dateTime.month,
            year: dateTime.year
        };
    }
    userTimeFormatToStruct(datetime) {
        if (!datetime) {
            return null;
        }
        const dateTime = this.toDateTime(datetime, '', {
            zone: this.preferences.getUserPreference('timezone')
        });
        if (!dateTime.isValid) {
            return null;
        }
        return {
            hour: dateTime.hour,
            minute: dateTime.minute,
            second: dateTime.second
        };
    }
    fromUserFormat(datetime, options, formatOptions) {
        // ensure datetime is in user format.
        datetime = this.toUserFormat(datetime, formatOptions);
        datetime = datetime.toString();
        datetime = datetime.replace('a', 'A');
        datetime = datetime.replace('p', 'P');
        datetime = datetime.replace('m', 'M');
        let format = this.getUserFormat();
        format = format.replace('aaaaa\'m\'', 'a');
        return DateTime.fromFormat(datetime, format, options);
    }
    fromInternalFormat(datetime, options) {
        const format = this.getInternalFormat();
        return DateTime.fromFormat(datetime.toString(), format, options);
    }
    validateUserFormat(inputValue, userFormat = '') {
        const trimmedInputValue = this.formUtils.getTrimmedInputValue(inputValue);
        if (this.formUtils.isEmptyInputValue(trimmedInputValue)) {
            return false;
        }
        const dateTime = this.fromUserFormat(trimmedInputValue, {}, { fromFormat: userFormat });
        return !dateTime.isValid;
    }
    userTimeZone() {
        let userTZ = this.preferences.getUserPreference('timezone') ?? 'GMT';
        if (!userTZ) {
            userTZ = 'GMT';
        }
        const milliseconds = DateTime.now().setZone(userTZ).toMillis();
        return IANAZone.create(userTZ).formatOffset(milliseconds, 'techie');
    }
    static { this.ɵfac = function DatetimeFormatter_Factory(t) { return new (t || DatetimeFormatter)(i0.ɵɵinject(i1.UserPreferenceStore), i0.ɵɵinject(i2.FormControlUtils), i0.ɵɵinject(LOCALE_ID)); }; }
    static { this.ɵprov = /*@__PURE__*/ i0.ɵɵdefineInjectable({ token: DatetimeFormatter, factory: DatetimeFormatter.ɵfac, providedIn: 'root' }); }
}
export { DatetimeFormatter };
(function () { (typeof ngDevMode === "undefined" || ngDevMode) && i0.ɵsetClassMetadata(DatetimeFormatter, [{
        type: Injectable,
        args: [{
                providedIn: 'root'
            }]
    }], function () { return [{ type: i1.UserPreferenceStore }, { type: i2.FormControlUtils }, { type: undefined, decorators: [{
                type: Inject,
                args: [LOCALE_ID]
            }] }]; }, null); })();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZXRpbWUtZm9ybWF0dGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9jb3JlL2FwcC9jb3JlL3NyYy9saWIvc2VydmljZXMvZm9ybWF0dGVycy9kYXRldGltZS9kYXRldGltZS1mb3JtYXR0ZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBd0JHO0FBRUgsT0FBTyxFQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQzVELE9BQU8sRUFBQyxtQkFBbUIsRUFBQyxNQUFNLHNEQUFzRCxDQUFDO0FBRXpGLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxnQkFBZ0IsQ0FBQztBQUNuQyxPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0saUJBQWlCLENBQUM7QUFFM0MsT0FBTyxFQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUMsTUFBTSxPQUFPLENBQUM7QUFFekMsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sdUNBQXVDLENBQUM7Ozs7QUFXdkUsTUFHYSxpQkFBaUI7SUFZMUIsWUFDYyxXQUFnQyxFQUNoQyxTQUEyQixFQUNYLE1BQWM7UUFGOUIsZ0JBQVcsR0FBWCxXQUFXLENBQXFCO1FBQ2hDLGNBQVMsR0FBVCxTQUFTLENBQWtCO1FBQ1gsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQWI1QyxZQUFPLEdBQWdDLElBQUksQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUN6RSxHQUFHLENBQUMsR0FBRyxFQUFFO1lBRUwsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ2xDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUVsQyxPQUFPLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBQyxDQUFDO1FBQ3hCLENBQUMsQ0FBQyxDQUNM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RSxDQUFDO2tGQWpTUSxpQkFBaUIscUZBZWQsU0FBUzt1RUFmWixpQkFBaUIsV0FBakIsaUJBQWlCLG1CQUZkLE1BQU07O1NBRVQsaUJBQWlCO3VGQUFqQixpQkFBaUI7Y0FIN0IsVUFBVTtlQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOztzQkFnQlEsTUFBTTt1QkFBQyxTQUFTIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTdWl0ZUNSTSBpcyBhIGN1c3RvbWVyIHJlbGF0aW9uc2hpcCBtYW5hZ2VtZW50IHByb2dyYW0gZGV2ZWxvcGVkIGJ5IFNhbGVzQWdpbGl0eSBMdGQuXG4gKiBDb3B5cmlnaHQgKEMpIDIwMjEgU2FsZXNBZ2lsaXR5IEx0ZC5cbiAqXG4gKiBUaGlzIHByb2dyYW0gaXMgZnJlZSBzb2Z0d2FyZTsgeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdCB1bmRlclxuICogdGhlIHRlcm1zIG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgdmVyc2lvbiAzIGFzIHB1Ymxpc2hlZCBieSB0aGVcbiAqIEZyZWUgU29mdHdhcmUgRm91bmRhdGlvbiB3aXRoIHRoZSBhZGRpdGlvbiBvZiB0aGUgZm9sbG93aW5nIHBlcm1pc3Npb24gYWRkZWRcbiAqIHRvIFNlY3Rpb24gMTUgYXMgcGVybWl0dGVkIGluIFNlY3Rpb24gNyhhKTogRk9SIEFOWSBQQVJUIE9GIFRIRSBDT1ZFUkVEIFdPUktcbiAqIElOIFdISUNIIFRIRSBDT1BZUklHSFQgSVMgT1dORUQgQlkgU0FMRVNBR0lMSVRZLCBTQUxFU0FHSUxJVFkgRElTQ0xBSU1TIFRIRVxuICogV0FSUkFOVFkgT0YgTk9OIElORlJJTkdFTUVOVCBPRiBUSElSRCBQQVJUWSBSSUdIVFMuXG4gKlxuICogVGhpcyBwcm9ncmFtIGlzIGRpc3RyaWJ1dGVkIGluIHRoZSBob3BlIHRoYXQgaXQgd2lsbCBiZSB1c2VmdWwsIGJ1dCBXSVRIT1VUXG4gKiBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTU1xuICogRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiBTZWUgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZVxuICogZGV0YWlscy5cbiAqXG4gKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2VcbiAqIGFsb25nIHdpdGggdGhpcyBwcm9ncmFtLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LlxuICpcbiAqIEluIGFjY29yZGFuY2Ugd2l0aCBTZWN0aW9uIDcoYikgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogdmVyc2lvbiAzLCB0aGVzZSBBcHByb3ByaWF0ZSBMZWdhbCBOb3RpY2VzIG11c3QgcmV0YWluIHRoZSBkaXNwbGF5IG9mIHRoZVxuICogXCJTdXBlcmNoYXJnZWQgYnkgU3VpdGVDUk1cIiBsb2dvLiBJZiB0aGUgZGlzcGxheSBvZiB0aGUgbG9nb3MgaXMgbm90IHJlYXNvbmFibHlcbiAqIGZlYXNpYmxlIGZvciB0ZWNobmljYWwgcmVhc29ucywgdGhlIEFwcHJvcHJpYXRlIExlZ2FsIE5vdGljZXMgbXVzdCBkaXNwbGF5XG4gKiB0aGUgd29yZHMgXCJTdXBlcmNoYXJnZWQgYnkgU3VpdGVDUk1cIi5cbiAqL1xuXG5pbXBvcnQge0luamVjdCwgSW5qZWN0YWJsZSwgTE9DQUxFX0lEfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7VXNlclByZWZlcmVuY2VTdG9yZX0gZnJvbSAnLi4vLi4vLi4vc3RvcmUvdXNlci1wcmVmZXJlbmNlL3VzZXItcHJlZmVyZW5jZS5zdG9yZSc7XG5pbXBvcnQge09ic2VydmFibGV9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHttYXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7Zm9ybWF0RGF0ZX0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7TmdiRGF0ZVN0cnVjdCwgTmdiVGltZVN0cnVjdH0gZnJvbSAnQG5nLWJvb3RzdHJhcC9uZy1ib290c3RyYXAnO1xuaW1wb3J0IHtEYXRlVGltZSwgSUFOQVpvbmV9IGZyb20gJ2x1eG9uJztcbmltcG9ydCB7Rm9ybWF0T3B0aW9ucywgRm9ybWF0dGVyfSBmcm9tICcuLi9mb3JtYXR0ZXIubW9kZWwnO1xuaW1wb3J0IHtGb3JtQ29udHJvbFV0aWxzfSBmcm9tICcuLi8uLi9yZWNvcmQvZmllbGQvZm9ybS1jb250cm9sLnV0aWxzJztcbmltcG9ydCB7RGF0ZVRpbWVPcHRpb25zfSBmcm9tIFwibHV4b24vc3JjL2RhdGV0aW1lXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGF0ZXRpbWVGb3JtYXRzIHtcbiAgICBkYXRlOiBzdHJpbmc7XG4gICAgdGltZTogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIERhdGVUaW1lU3RydWN0IGV4dGVuZHMgTmdiRGF0ZVN0cnVjdCwgTmdiVGltZVN0cnVjdCB7XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgRGF0ZXRpbWVGb3JtYXR0ZXIgaW1wbGVtZW50cyBGb3JtYXR0ZXIge1xuXG4gICAgZm9ybWF0JDogT2JzZXJ2YWJsZTxEYXRldGltZUZvcm1hdHM+ID0gdGhpcy5wcmVmZXJlbmNlcy51c2VyUHJlZmVyZW5jZXMkLnBpcGUoXG4gICAgICAgIG1hcCgoKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnN0IGRhdGUgPSB0aGlzLmdldERhdGVGb3JtYXQoKTtcbiAgICAgICAgICAgIGNvbnN0IHRpbWUgPSB0aGlzLmdldFRpbWVGb3JtYXQoKTtcblxuICAgICAgICAgICAgcmV0dXJuIHtkYXRlLCB0aW1lfTtcbiAgICAgICAgfSlcbiAgICApO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByb3RlY3RlZCBwcmVmZXJlbmNlczogVXNlclByZWZlcmVuY2VTdG9yZSxcbiAgICAgICAgcHJvdGVjdGVkIGZvcm1VdGlsczogRm9ybUNvbnRyb2xVdGlscyxcbiAgICAgICAgQEluamVjdChMT0NBTEVfSUQpIHB1YmxpYyBsb2NhbGU6IHN0cmluZ1xuICAgICkge1xuXG4gICAgfVxuXG4gICAgZ2V0RGF0ZUZvcm1hdCgpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBkYXRlRm9ybWF0UHJlZmVyZW5jZSA9IHRoaXMucHJlZmVyZW5jZXMuZ2V0VXNlclByZWZlcmVuY2UoJ2RhdGVfZm9ybWF0Jyk7XG5cbiAgICAgICAgaWYgKGRhdGVGb3JtYXRQcmVmZXJlbmNlKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0ZUZvcm1hdFByZWZlcmVuY2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5nZXRJbnRlcm5hbFRpbWVGb3JtYXQoKTtcbiAgICB9XG5cbiAgICBnZXRUaW1lRm9ybWF0KCk6IHN0cmluZyB7XG5cbiAgICAgICAgY29uc3QgdGltZUZvcm1hdFByZWZlcmVuY2UgPSB0aGlzLnByZWZlcmVuY2VzLmdldFVzZXJQcmVmZXJlbmNlKCd0aW1lX2Zvcm1hdCcpO1xuXG4gICAgICAgIGlmICh0aW1lRm9ybWF0UHJlZmVyZW5jZSkge1xuICAgICAgICAgICAgbGV0IGZvcm1hdDogc3RyaW5nID0gdGltZUZvcm1hdFByZWZlcmVuY2U7XG5cbiAgICAgICAgICAgIGlmIChmb3JtYXQuaW5jbHVkZXMoJ2FhYWFhYScpKSB7XG4gICAgICAgICAgICAgICAgZm9ybWF0ID0gZm9ybWF0LnJlcGxhY2UoJ2FhYWFhYScsICdhYWFhYVxcJ21cXCcnKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIGZvcm1hdDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmdldEludGVybmFsVGltZUZvcm1hdCgpO1xuICAgIH1cblxuICAgIGdldERhdGVUaW1lRm9ybWF0KCk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGRhdGVGb3JtYXQgPSB0aGlzLmdldERhdGVGb3JtYXQoKTtcbiAgICAgICAgY29uc3QgdGltZUZvcm1hdCA9IHRoaXMuZ2V0VGltZUZvcm1hdCgpO1xuICAgICAgICByZXR1cm4gZGF0ZUZvcm1hdCArICcgJyArIHRpbWVGb3JtYXQ7XG4gICAgfVxuXG4gICAgZ2V0SW50ZXJuYWxEYXRlRm9ybWF0KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAneXl5eS1NTS1kZCc7XG4gICAgfVxuXG4gICAgZ2V0SW50ZXJuYWxUaW1lRm9ybWF0KCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiAnSEg6bW06c3MnO1xuICAgIH1cblxuICAgIGdldEludGVybmFsRGF0ZVRpbWVGb3JtYXQoKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZGF0ZUZvcm1hdCA9IHRoaXMuZ2V0SW50ZXJuYWxEYXRlRm9ybWF0KCk7XG4gICAgICAgIGNvbnN0IHRpbWVGb3JtYXQgPSB0aGlzLmdldEludGVybmFsVGltZUZvcm1hdCgpO1xuICAgICAgICByZXR1cm4gZGF0ZUZvcm1hdCArICcgJyArIHRpbWVGb3JtYXQ7XG4gICAgfVxuXG4gICAgZ2V0SW50ZXJuYWxGb3JtYXQoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0SW50ZXJuYWxEYXRlVGltZUZvcm1hdCgpO1xuICAgIH1cblxuICAgIGdldFVzZXJGb3JtYXQoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGF0ZVRpbWVGb3JtYXQoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBGb3JtYXQgSW50ZXJuYWwgRGF0ZSB0byBVc2VyLiBJdCBhc3N1bWVzIGludGVybmFsIGRhdGUgaXMgaW4gR01UL1VUQ1xuICAgICAqXG4gICAgICogQHBhcmFtIGRhdGVTdHJpbmdcbiAgICAgKiBAcGFyYW0gb3B0aW9uc1xuICAgICAqL1xuICAgIHRvVXNlckZvcm1hdChkYXRlU3RyaW5nOiBzdHJpbmcsIG9wdGlvbnM/OiBGb3JtYXRPcHRpb25zKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZnJvbUZvcm1hdCA9IChvcHRpb25zICYmIG9wdGlvbnMuZnJvbUZvcm1hdCkgfHwgdGhpcy5nZXRJbnRlcm5hbEZvcm1hdCgpO1xuICAgICAgICBpZiAoZGF0ZVN0cmluZykge1xuICAgICAgICAgICAgY29uc3QgZGF0ZVRpbWUgPSB0aGlzLnRvRGF0ZVRpbWUoZGF0ZVN0cmluZywgZnJvbUZvcm1hdCwgIHtcbiAgICAgICAgICAgICAgICB6b25lOiAnR01UJ1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmICghZGF0ZVRpbWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBkYXRlU3RyaW5nO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIGZvcm1hdERhdGUoZGF0ZVRpbWUudG9KU0RhdGUoKSwgdGhpcy5nZXRVc2VyRm9ybWF0KCksIHRoaXMubG9jYWxlLCB0aGlzLnVzZXJUaW1lWm9uZSgpKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRm9ybWF0IFVzZXIgRGF0ZSB0byBJbnRlcm5hbCBmb3JtYXQuIEl0IGFzc3VtZXMgdGhlIGRhdGUgaXMgaW4gdGhlIHVzZXIgdGltZXpvbmVcbiAgICAgKlxuICAgICAqIEBwYXJhbSBkYXRlU3RyaW5nXG4gICAgICogQHBhcmFtIG9wdGlvbnNcbiAgICAgKi9cbiAgICB0b0ludGVybmFsRm9ybWF0KGRhdGVTdHJpbmc6IHN0cmluZywgb3B0aW9ucz86IEZvcm1hdE9wdGlvbnMpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBmcm9tRm9ybWF0ID0gKG9wdGlvbnMgJiYgb3B0aW9ucy5mcm9tRm9ybWF0KSB8fCB0aGlzLmdldFVzZXJGb3JtYXQoKTtcbiAgICAgICAgaWYgKGRhdGVTdHJpbmcpIHtcblxuICAgICAgICAgICAgbGV0IGRhdGUgPSB0aGlzLnRvRGF0ZVRpbWUoZGF0ZVN0cmluZywgZnJvbUZvcm1hdCwge1xuICAgICAgICAgICAgICAgIHpvbmU6IHRoaXMucHJlZmVyZW5jZXMuZ2V0VXNlclByZWZlcmVuY2UoJ3RpbWV6b25lJylcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXR1cm4gZm9ybWF0RGF0ZShkYXRlLnRvSlNEYXRlKCksIHRoaXMuZ2V0SW50ZXJuYWxGb3JtYXQoKSwgdGhpcy5sb2NhbGUsICdHTVQnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gJyc7XG4gICAgfVxuXG4gICAgZm9ybWF0RGF0ZVRpbWUoZGF0ZVN0cmluZzogc3RyaW5nLCBmb3JtYXQ6IHN0cmluZywgZnJvbUZvcm1hdCA9ICcnLCBsb2NhbGUgPSB0aGlzLmxvY2FsZSwgdGltZXpvbmUgPSAnJyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGRhdGVUaW1lID0gdGhpcy50b0RhdGVUaW1lKGRhdGVTdHJpbmcsIGZyb21Gb3JtYXQpO1xuXG4gICAgICAgIGlmICghZGF0ZVRpbWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIGRhdGVTdHJpbmc7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGZvcm1hdERhdGUoZGF0ZVRpbWUudG9KU0RhdGUoKSwgZm9ybWF0LCBsb2NhbGUsIHRpbWV6b25lKTtcbiAgICB9XG5cbiAgICB0b0RhdGVUaW1lKGRhdGV0aW1lU3RyaW5nOiBzdHJpbmcsIGZyb21Gb3JtYXQgPSAnJywgb3B0aW9ucz86IERhdGVUaW1lT3B0aW9ucyk6IERhdGVUaW1lIHtcbiAgICAgICAgaWYgKCFkYXRldGltZVN0cmluZykge1xuICAgICAgICAgICAgcmV0dXJuIERhdGVUaW1lLmludmFsaWQoJ2VtcHR5Jyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZnJvbUZvcm1hdCkge1xuICAgICAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQoZGF0ZXRpbWVTdHJpbmcsIGZyb21Gb3JtYXQsIG9wdGlvbnMpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGRhdGVUaW1lID0gdGhpcy5mcm9tVXNlckZvcm1hdChkYXRldGltZVN0cmluZywgb3B0aW9ucyk7XG4gICAgICAgIGlmICghZGF0ZVRpbWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgZGF0ZVRpbWUgPSB0aGlzLmZyb21JbnRlcm5hbEZvcm1hdChkYXRldGltZVN0cmluZywgb3B0aW9ucyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0ZVRpbWU7XG4gICAgfVxuXG4gICAgdXNlckRhdGVUaW1lRm9ybWF0VG9TdHJ1Y3QoZGF0ZXRpbWU6IHN0cmluZyk6IHsgZGF0ZTogTmdiRGF0ZVN0cnVjdDsgdGltZTogTmdiVGltZVN0cnVjdCB9IHtcbiAgICAgICAgaWYgKCFkYXRldGltZSkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkYXRlVGltZSA9IHRoaXMudG9EYXRlVGltZShkYXRldGltZSwgJycsICB7XG4gICAgICAgICAgICB6b25lOiB0aGlzLnByZWZlcmVuY2VzLmdldFVzZXJQcmVmZXJlbmNlKCd0aW1lem9uZScpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghZGF0ZVRpbWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGF0ZToge1xuICAgICAgICAgICAgICAgIGRheTogZGF0ZVRpbWUuZGF5LFxuICAgICAgICAgICAgICAgIG1vbnRoOiBkYXRlVGltZS5tb250aCxcbiAgICAgICAgICAgICAgICB5ZWFyOiBkYXRlVGltZS55ZWFyXG4gICAgICAgICAgICB9IGFzIE5nYkRhdGVTdHJ1Y3QsXG4gICAgICAgICAgICB0aW1lOiB7XG4gICAgICAgICAgICAgICAgaG91cjogZGF0ZVRpbWUuaG91cixcbiAgICAgICAgICAgICAgICBtaW51dGU6IGRhdGVUaW1lLm1pbnV0ZSxcbiAgICAgICAgICAgICAgICBzZWNvbmQ6IGRhdGVUaW1lLnNlY29uZCxcbiAgICAgICAgICAgIH0gYXMgTmdiVGltZVN0cnVjdFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGludGVybmFsRGF0ZVRpbWVGb3JtYXRUb1N0cnVjdChkYXRldGltZTogc3RyaW5nKTogeyBkYXRlOiBOZ2JEYXRlU3RydWN0OyB0aW1lOiBOZ2JUaW1lU3RydWN0IH0ge1xuICAgICAgICBpZiAoIWRhdGV0aW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGRhdGVUaW1lID0gdGhpcy50b0RhdGVUaW1lKGRhdGV0aW1lLCB0aGlzLmdldEludGVybmFsRGF0ZVRpbWVGb3JtYXQoKSwge1xuICAgICAgICAgICAgem9uZTogJ0dNVCdcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgcmV6b25lZCA9IGRhdGVUaW1lLnNldFpvbmUodGhpcy5wcmVmZXJlbmNlcy5nZXRVc2VyUHJlZmVyZW5jZSgndGltZXpvbmUnKSk7XG5cbiAgICAgICAgaWYgKCFkYXRlVGltZS5pc1ZhbGlkKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBkYXRlOiB7XG4gICAgICAgICAgICAgICAgZGF5OiByZXpvbmVkLmRheSxcbiAgICAgICAgICAgICAgICBtb250aDogcmV6b25lZC5tb250aCxcbiAgICAgICAgICAgICAgICB5ZWFyOiByZXpvbmVkLnllYXJcbiAgICAgICAgICAgIH0gYXMgTmdiRGF0ZVN0cnVjdCxcbiAgICAgICAgICAgIHRpbWU6IHtcbiAgICAgICAgICAgICAgICBob3VyOiByZXpvbmVkLmhvdXIsXG4gICAgICAgICAgICAgICAgbWludXRlOiByZXpvbmVkLm1pbnV0ZSxcbiAgICAgICAgICAgICAgICBzZWNvbmQ6IHJlem9uZWQuc2Vjb25kLFxuICAgICAgICAgICAgfSBhcyBOZ2JUaW1lU3RydWN0XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgdXNlckRhdGVGb3JtYXRUb1N0cnVjdChkYXRldGltZTogc3RyaW5nKTogTmdiRGF0ZVN0cnVjdCB7XG4gICAgICAgIGlmICghZGF0ZXRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF0ZVRpbWUgPSB0aGlzLnRvRGF0ZVRpbWUoZGF0ZXRpbWUsICcnLCB7XG4gICAgICAgICAgICB6b25lOiB0aGlzLnByZWZlcmVuY2VzLmdldFVzZXJQcmVmZXJlbmNlKCd0aW1lem9uZScpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghZGF0ZVRpbWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgZGF5OiBkYXRlVGltZS5kYXksXG4gICAgICAgICAgICBtb250aDogZGF0ZVRpbWUubW9udGgsXG4gICAgICAgICAgICB5ZWFyOiBkYXRlVGltZS55ZWFyXG4gICAgICAgIH0gYXMgTmdiRGF0ZVN0cnVjdDtcbiAgICB9XG5cbiAgICBkYXRlRm9ybWF0VG9TdHJ1Y3QoZGF0ZXRpbWU6IHN0cmluZywgZnJvbUZvcm1hdCA9ICcnKTogTmdiRGF0ZVN0cnVjdCB7XG4gICAgICAgIGlmICghZGF0ZXRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF0ZVRpbWUgPSB0aGlzLnRvRGF0ZVRpbWUoZGF0ZXRpbWUsIGZyb21Gb3JtYXQpO1xuICAgICAgICBpZiAoIWRhdGVUaW1lLmlzVmFsaWQpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGRheTogZGF0ZVRpbWUuZGF5LFxuICAgICAgICAgICAgbW9udGg6IGRhdGVUaW1lLm1vbnRoLFxuICAgICAgICAgICAgeWVhcjogZGF0ZVRpbWUueWVhclxuICAgICAgICB9IGFzIE5nYkRhdGVTdHJ1Y3Q7XG4gICAgfVxuXG4gICAgdXNlclRpbWVGb3JtYXRUb1N0cnVjdChkYXRldGltZTogc3RyaW5nKTogTmdiVGltZVN0cnVjdCB7XG4gICAgICAgIGlmICghZGF0ZXRpbWUpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZGF0ZVRpbWUgPSB0aGlzLnRvRGF0ZVRpbWUoZGF0ZXRpbWUsICcnLCB7XG4gICAgICAgICAgICB6b25lOiB0aGlzLnByZWZlcmVuY2VzLmdldFVzZXJQcmVmZXJlbmNlKCd0aW1lem9uZScpXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmICghZGF0ZVRpbWUuaXNWYWxpZCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaG91cjogZGF0ZVRpbWUuaG91cixcbiAgICAgICAgICAgIG1pbnV0ZTogZGF0ZVRpbWUubWludXRlLFxuICAgICAgICAgICAgc2Vjb25kOiBkYXRlVGltZS5zZWNvbmRcbiAgICAgICAgfSBhcyBOZ2JUaW1lU3RydWN0O1xuICAgIH1cblxuICAgIGZyb21Vc2VyRm9ybWF0KGRhdGV0aW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBEYXRlVGltZU9wdGlvbnMsIGZvcm1hdE9wdGlvbnM/OiBGb3JtYXRPcHRpb25zKTogRGF0ZVRpbWUge1xuICAgICAgICAvLyBlbnN1cmUgZGF0ZXRpbWUgaXMgaW4gdXNlciBmb3JtYXQuXG4gICAgICAgIGRhdGV0aW1lID0gdGhpcy50b1VzZXJGb3JtYXQoZGF0ZXRpbWUsIGZvcm1hdE9wdGlvbnMpO1xuICAgICAgICBkYXRldGltZSA9IGRhdGV0aW1lLnRvU3RyaW5nKCk7XG4gICAgICAgIGRhdGV0aW1lID0gZGF0ZXRpbWUucmVwbGFjZSgnYScsICdBJyk7XG4gICAgICAgIGRhdGV0aW1lID0gZGF0ZXRpbWUucmVwbGFjZSgncCcsICdQJyk7XG4gICAgICAgIGRhdGV0aW1lID0gZGF0ZXRpbWUucmVwbGFjZSgnbScsICdNJyk7XG5cbiAgICAgICAgbGV0IGZvcm1hdCA9IHRoaXMuZ2V0VXNlckZvcm1hdCgpO1xuICAgICAgICBmb3JtYXQgPSBmb3JtYXQucmVwbGFjZSgnYWFhYWFcXCdtXFwnJywgJ2EnKTtcbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQoZGF0ZXRpbWUsIGZvcm1hdCwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgZnJvbUludGVybmFsRm9ybWF0KGRhdGV0aW1lOiBzdHJpbmcsIG9wdGlvbnM/OiBEYXRlVGltZU9wdGlvbnMpOiBEYXRlVGltZSB7XG4gICAgICAgIGNvbnN0IGZvcm1hdCA9IHRoaXMuZ2V0SW50ZXJuYWxGb3JtYXQoKTtcbiAgICAgICAgcmV0dXJuIERhdGVUaW1lLmZyb21Gb3JtYXQoZGF0ZXRpbWUudG9TdHJpbmcoKSwgZm9ybWF0LCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICB2YWxpZGF0ZVVzZXJGb3JtYXQoaW5wdXRWYWx1ZTogYW55LCB1c2VyRm9ybWF0OiBzdHJpbmcgPSAnJyk6IGJvb2xlYW4ge1xuXG4gICAgICAgIGNvbnN0IHRyaW1tZWRJbnB1dFZhbHVlID0gdGhpcy5mb3JtVXRpbHMuZ2V0VHJpbW1lZElucHV0VmFsdWUoaW5wdXRWYWx1ZSk7XG4gICAgICAgIGlmICh0aGlzLmZvcm1VdGlscy5pc0VtcHR5SW5wdXRWYWx1ZSh0cmltbWVkSW5wdXRWYWx1ZSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBkYXRlVGltZSA9IHRoaXMuZnJvbVVzZXJGb3JtYXQodHJpbW1lZElucHV0VmFsdWUsIHt9LHtmcm9tRm9ybWF0OiB1c2VyRm9ybWF0fSk7XG4gICAgICAgIHJldHVybiAhZGF0ZVRpbWUuaXNWYWxpZDtcbiAgICB9XG5cbiAgICB1c2VyVGltZVpvbmUoKTogc3RyaW5nIHtcbiAgICAgICAgbGV0IHVzZXJUWiA9IHRoaXMucHJlZmVyZW5jZXMuZ2V0VXNlclByZWZlcmVuY2UoJ3RpbWV6b25lJykgPz8gJ0dNVCc7XG4gICAgICAgIGlmICghdXNlclRaKSB7XG4gICAgICAgICAgICB1c2VyVFogPSAnR01UJztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBtaWxsaXNlY29uZHMgPSBEYXRlVGltZS5ub3coKS5zZXRab25lKHVzZXJUWikudG9NaWxsaXMoKTtcbiAgICAgICAgcmV0dXJuIElBTkFab25lLmNyZWF0ZSh1c2VyVFopLmZvcm1hdE9mZnNldChtaWxsaXNlY29uZHMsICd0ZWNoaWUnKTtcbiAgICB9XG5cblxufVxuIl19